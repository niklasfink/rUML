function forEach(e,o){for(var t=0,n=e.length;n>t;++t)o(e[t],t)}function addDoc(e,o,t){for(var n=[],a="",s=0;o>s;++s)a+="x";for(var s=0;t>s;++s)n.push(a);e.setValue(n.join("\n"))}function byClassName(e,o){function t(e){if(3!=e.nodeType){a.test(e.className)&&n.push(e);for(var o=0,s=e.childNodes.length;s>o;++o)t(e.childNodes[o])}}if(e.getElementsByClassName)return e.getElementsByClassName(o);var n=[],a=new RegExp("\\b"+o+"\\b");return t(e),n}function foldLines(e,o,t,n){return e.markText(Pos(o,0),Pos(t-1),{inclusiveLeft:!0,inclusiveRight:!0,collapsed:!0,clearOnEnter:n})}function scrollbarWidth(e){if(null!=knownScrollbarWidth)return knownScrollbarWidth;var o=document.createElement("div");return o.style.cssText="width: 50px; height: 50px; overflow-x: scroll",document.body.appendChild(o),knownScrollbarWidth=o.offsetHeight-o.clientHeight,document.body.removeChild(o),knownScrollbarWidth||0}var Pos=CodeMirror.Pos;CodeMirror.defaults.rtlMoveVisually=!0;var ie_lt8=/MSIE [1-7]\b/.test(navigator.userAgent),ie_lt9=/MSIE [1-8]\b/.test(navigator.userAgent),mac=/Mac/.test(navigator.platform),phantom=/PhantomJS/.test(navigator.userAgent),opera=/Opera\/\./.test(navigator.userAgent),opera_version=opera&&navigator.userAgent.match(/Version\/(\d+\.\d+)/);opera_version&&(opera_version=Number(opera_version));var opera_lt10=opera&&(!opera_version||10>opera_version);namespace="core_",test("core_fromTextArea",function(){var e=document.getElementById("code");e.value="CONTENT";var o=CodeMirror.fromTextArea(e);is(!e.offsetHeight),eq(o.getValue(),"CONTENT"),o.setValue("foo\nbar"),eq(o.getValue(),"foo\nbar"),o.save(),is(/^foo\r?\nbar$/.test(e.value)),o.setValue("xxx"),o.toTextArea(),is(e.offsetHeight),eq(e.value,"xxx")}),testCM("getRange",function(e){eq(e.getLine(0),"1234"),eq(e.getLine(1),"5678"),eq(e.getLine(2),null),eq(e.getLine(-1),null),eq(e.getRange(Pos(0,0),Pos(0,3)),"123"),eq(e.getRange(Pos(0,-1),Pos(0,200)),"1234"),eq(e.getRange(Pos(0,2),Pos(1,2)),"34\n56"),eq(e.getRange(Pos(1,2),Pos(100,0)),"78")},{value:"1234\n5678"}),testCM("replaceRange",function(e){eq(e.getValue(),""),e.replaceRange("foo\n",Pos(0,0)),eq(e.getValue(),"foo\n"),e.replaceRange("a\nb",Pos(0,1)),eq(e.getValue(),"fa\nboo\n"),eq(e.lineCount(),3),e.replaceRange("xyzzy",Pos(0,0),Pos(1,1)),eq(e.getValue(),"xyzzyoo\n"),e.replaceRange("abc",Pos(0,0),Pos(10,0)),eq(e.getValue(),"abc"),eq(e.lineCount(),1)}),testCM("selection",function(e){e.setSelection(Pos(0,4),Pos(2,2)),is(e.somethingSelected()),eq(e.getSelection(),"11\n222222\n33"),eqPos(e.getCursor(!1),Pos(2,2)),eqPos(e.getCursor(!0),Pos(0,4)),e.setSelection(Pos(1,0)),is(!e.somethingSelected()),eq(e.getSelection(),""),eqPos(e.getCursor(!0),Pos(1,0)),e.replaceSelection("abc","around"),eq(e.getSelection(),"abc"),eq(e.getValue(),"111111\nabc222222\n333333"),e.replaceSelection("def","end"),eq(e.getSelection(),""),eqPos(e.getCursor(!0),Pos(1,3)),e.setCursor(Pos(2,1)),eqPos(e.getCursor(!0),Pos(2,1)),e.setCursor(1,2),eqPos(e.getCursor(!0),Pos(1,2))},{value:"111111\n222222\n333333"}),testCM("extendSelection",function(e){e.setExtending(!0),addDoc(e,10,10),e.setSelection(Pos(3,5)),eqPos(e.getCursor("head"),Pos(3,5)),eqPos(e.getCursor("anchor"),Pos(3,5)),e.setSelection(Pos(2,5),Pos(5,5)),eqPos(e.getCursor("head"),Pos(5,5)),eqPos(e.getCursor("anchor"),Pos(2,5)),eqPos(e.getCursor("start"),Pos(2,5)),eqPos(e.getCursor("end"),Pos(5,5)),e.setSelection(Pos(5,5),Pos(2,5)),eqPos(e.getCursor("head"),Pos(2,5)),eqPos(e.getCursor("anchor"),Pos(5,5)),eqPos(e.getCursor("start"),Pos(2,5)),eqPos(e.getCursor("end"),Pos(5,5)),e.extendSelection(Pos(3,2)),eqPos(e.getCursor("head"),Pos(3,2)),eqPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(6,2)),eqPos(e.getCursor("head"),Pos(6,2)),eqPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(6,3),Pos(6,4)),eqPos(e.getCursor("head"),Pos(6,4)),eqPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(0,3),Pos(0,4)),eqPos(e.getCursor("head"),Pos(0,3)),eqPos(e.getCursor("anchor"),Pos(5,5)),e.extendSelection(Pos(4,5),Pos(6,5)),eqPos(e.getCursor("head"),Pos(6,5)),eqPos(e.getCursor("anchor"),Pos(4,5)),e.setExtending(!1),e.extendSelection(Pos(0,3),Pos(0,4)),eqPos(e.getCursor("head"),Pos(0,3)),eqPos(e.getCursor("anchor"),Pos(0,4))}),testCM("lines",function(e){eq(e.getLine(0),"111111"),eq(e.getLine(1),"222222"),eq(e.getLine(-1),null),e.replaceRange("",Pos(1,0),Pos(2,0)),e.replaceRange("abc",Pos(1,0),Pos(1)),eq(e.getValue(),"111111\nabc")},{value:"111111\n222222\n333333"}),testCM("indent",function(e){e.indentLine(1),eq(e.getLine(1),"   blah();"),e.setOption("indentUnit",8),e.indentLine(1),eq(e.getLine(1),"	blah();"),e.setOption("indentUnit",10),e.setOption("tabSize",4),e.indentLine(1),eq(e.getLine(1),"		  blah();")},{value:"if (x) {\nblah();\n}",indentUnit:3,indentWithTabs:!0,tabSize:8}),testCM("indentByNumber",function(e){e.indentLine(0,2),eq(e.getLine(0),"  foo"),e.indentLine(0,-200),eq(e.getLine(0),"foo"),e.setSelection(Pos(0,0),Pos(1,2)),e.indentSelection(3),eq(e.getValue(),"   foo\n   bar\nbaz")},{value:"foo\nbar\nbaz"}),test("core_defaults",function(){var e={},o=CodeMirror.defaults;for(var t in o)e[t]=o[t];o.indentUnit=5,o.value="uu",o.indentWithTabs=!0,o.tabindex=55;var n=document.getElementById("testground"),a=CodeMirror(n);try{eq(a.getOption("indentUnit"),5),a.setOption("indentUnit",10),eq(o.indentUnit,5),eq(a.getValue(),"uu"),eq(a.getOption("indentWithTabs"),!0),eq(a.getInputField().tabIndex,55)}finally{for(var t in e)o[t]=e[t];n.removeChild(a.getWrapperElement())}}),testCM("lineInfo",function(e){eq(e.lineInfo(-1),null);var o=document.createElement("span"),t=e.setGutterMarker(1,"FOO",o),n=e.lineInfo(1);eq(n.text,"222222"),eq(n.gutterMarkers.FOO,o),eq(n.line,1),eq(e.lineInfo(2).gutterMarkers,null),e.setGutterMarker(t,"FOO",null),eq(e.lineInfo(1).gutterMarkers,null),e.setGutterMarker(1,"FOO",o),e.setGutterMarker(0,"FOO",o),e.clearGutter("FOO"),eq(e.lineInfo(0).gutterMarkers,null),eq(e.lineInfo(1).gutterMarkers,null)},{value:"111111\n222222\n333333"}),testCM("coords",function(e){e.setSize(null,100),addDoc(e,32,200);var o=e.charCoords(Pos(0,0)),t=e.charCoords(Pos(200,30));is(o.left<t.left),is(o.top<t.top),is(o.top<o.bottom),e.scrollTo(null,100);var n=e.charCoords(Pos(0,0));is(o.top>n.top),eq(o.left,n.left)}),testCM("coordsChar",function(e){addDoc(e,35,70);for(var o=0;2>o;++o)for(var t=o?"local":"page",n=0;35>=n;n+=5)for(var a=0;70>a;a+=5){e.setCursor(a,n);var s=e.charCoords(Pos(a,n),t),r=e.coordsChar({left:s.left+1,top:s.top+1},t);eqPos(r,Pos(a,n))}},{lineNumbers:!0}),testCM("posFromIndex",function(e){e.setValue("This function should\nconvert a zero based index\nto line and ch.");for(var o=[{index:-1,line:0,ch:0},{index:0,line:0,ch:0},{index:10,line:0,ch:10},{index:39,line:1,ch:18},{index:55,line:2,ch:7},{index:63,line:2,ch:15},{index:64,line:2,ch:15}],t=0;t<o.length;t++){var n=o[t],a=e.posFromIndex(n.index);eq(a.line,n.line),eq(a.ch,n.ch),n.index>=0&&n.index<64&&eq(e.indexFromPos(a),n.index)}}),testCM("undo",function(e){e.replaceRange("def",Pos(0,0),Pos(0)),eq(e.historySize().undo,1),e.undo(),eq(e.getValue(),"abc"),eq(e.historySize().undo,0),eq(e.historySize().redo,1),e.redo(),eq(e.getValue(),"def"),eq(e.historySize().undo,1),eq(e.historySize().redo,0),e.setValue("1\n\n\n2"),e.clearHistory(),eq(e.historySize().undo,0);for(var o=0;20>o;++o)e.replaceRange("a",Pos(0,0)),e.replaceRange("b",Pos(3,0));eq(e.historySize().undo,40);for(var o=0;40>o;++o)e.undo();eq(e.historySize().redo,40),eq(e.getValue(),"1\n\n\n2")},{value:"abc"}),testCM("undoDepth",function(e){e.replaceRange("d",Pos(0)),e.replaceRange("e",Pos(0)),e.replaceRange("f",Pos(0)),e.undo(),e.undo(),e.undo(),eq(e.getValue(),"abcd")},{value:"abc",undoDepth:4}),testCM("undoDoesntClearValue",function(e){e.undo(),eq(e.getValue(),"x")},{value:"x"}),testCM("undoMultiLine",function(e){e.operation(function(){e.replaceRange("x",Pos(0,0)),e.replaceRange("y",Pos(1,0))}),e.undo(),eq(e.getValue(),"abc\ndef\nghi"),e.operation(function(){e.replaceRange("y",Pos(1,0)),e.replaceRange("x",Pos(0,0))}),e.undo(),eq(e.getValue(),"abc\ndef\nghi"),e.operation(function(){e.replaceRange("y",Pos(2,0)),e.replaceRange("x",Pos(1,0)),e.replaceRange("z",Pos(2,0))}),e.undo(),eq(e.getValue(),"abc\ndef\nghi",3)},{value:"abc\ndef\nghi"}),testCM("undoComposite",function(e){e.replaceRange("y",Pos(1)),e.operation(function(){e.replaceRange("x",Pos(0)),e.replaceRange("z",Pos(2))}),eq(e.getValue(),"ax\nby\ncz\n"),e.undo(),eq(e.getValue(),"a\nby\nc\n"),e.undo(),eq(e.getValue(),"a\nb\nc\n"),e.redo(),e.redo(),eq(e.getValue(),"ax\nby\ncz\n")},{value:"a\nb\nc\n"}),testCM("undoSelection",function(e){e.setSelection(Pos(0,2),Pos(0,4)),e.replaceSelection(""),e.setCursor(Pos(1,0)),e.undo(),eqPos(e.getCursor(!0),Pos(0,2)),eqPos(e.getCursor(!1),Pos(0,4)),e.setCursor(Pos(1,0)),e.redo(),eqPos(e.getCursor(!0),Pos(0,2)),eqPos(e.getCursor(!1),Pos(0,2))},{value:"abcdefgh\n"}),testCM("undoSelectionAsBefore",function(e){e.replaceSelection("abc","around"),e.undo(),e.redo(),eq(e.getSelection(),"abc")}),testCM("selectionChangeConfusesHistory",function(e){e.replaceSelection("abc",null,"dontmerge"),e.operation(function(){e.setCursor(Pos(0,0)),e.replaceSelection("abc",null,"dontmerge")}),eq(e.historySize().undo,2)}),testCM("markTextSingleLine",function(e){forEach([{a:0,b:1,c:"",f:2,t:5},{a:0,b:4,c:"",f:0,t:2},{a:1,b:2,c:"x",f:3,t:6},{a:4,b:5,c:"",f:3,t:5},{a:4,b:5,c:"xx",f:3,t:7},{a:2,b:5,c:"",f:2,t:3},{a:2,b:5,c:"abcd",f:6,t:7},{a:2,b:6,c:"x",f:null,t:null},{a:3,b:6,c:"",f:null,t:null},{a:0,b:9,c:"hallo",f:null,t:null},{a:4,b:6,c:"x",f:3,t:4},{a:4,b:8,c:"",f:3,t:4},{a:6,b:6,c:"a",f:3,t:6},{a:8,b:9,c:"",f:3,t:6}],function(o){e.setValue("1234567890");var t=e.markText(Pos(0,3),Pos(0,6),{className:"foo"});e.replaceRange(o.c,Pos(0,o.a),Pos(0,o.b));var n=t.find();eq(n&&n.from.ch,o.f),eq(n&&n.to.ch,o.t)})}),testCM("markTextMultiLine",function(e){function o(e){return e&&Pos(e[0],e[1])}forEach([{a:[0,0],b:[0,5],c:"",f:[0,0],t:[2,5]},{a:[0,0],b:[0,5],c:"foo\n",f:[1,0],t:[3,5]},{a:[0,1],b:[0,10],c:"",f:[0,1],t:[2,5]},{a:[0,5],b:[0,6],c:"x",f:[0,6],t:[2,5]},{a:[0,0],b:[1,0],c:"",f:[0,0],t:[1,5]},{a:[0,6],b:[2,4],c:"",f:[0,5],t:[0,7]},{a:[0,6],b:[2,4],c:"aa",f:[0,5],t:[0,9]},{a:[1,2],b:[1,8],c:"",f:[0,5],t:[2,5]},{a:[0,5],b:[2,5],c:"xx",f:null,t:null},{a:[0,0],b:[2,10],c:"x",f:null,t:null},{a:[1,5],b:[2,5],c:"",f:[0,5],t:[1,5]},{a:[2,0],b:[2,3],c:"",f:[0,5],t:[2,2]},{a:[2,5],b:[3,0],c:"a\nb",f:[0,5],t:[2,5]},{a:[2,3],b:[3,0],c:"x",f:[0,5],t:[2,3]},{a:[1,1],b:[1,9],c:"1\n2\n3",f:[0,5],t:[4,5]}],function(t){e.setValue("aaaaaaaaaa\nbbbbbbbbbb\ncccccccccc\ndddddddd\n");var n=e.markText(Pos(0,5),Pos(2,5),{className:"CodeMirror-matchingbracket"});e.replaceRange(t.c,o(t.a),o(t.b));var a=n.find();eqPos(a&&a.from,o(t.f)),eqPos(a&&a.to,o(t.t))})}),testCM("markTextUndo",function(e){var o,t,n;o=e.markText(Pos(0,1),Pos(0,3),{className:"CodeMirror-matchingbracket"}),t=e.markText(Pos(0,0),Pos(2,1),{className:"CodeMirror-matchingbracket"}),n=e.setBookmark(Pos(1,5)),e.operation(function(){e.replaceRange("foo",Pos(0,2)),e.replaceRange("bar\nbaz\nbug\n",Pos(2,0),Pos(3,0))});var a=e.getValue();e.setValue(""),eq(o.find(),null),eq(t.find(),null),eq(n.find(),null),e.undo(),eqPos(n.find(),Pos(1,5),"still there"),e.undo();var s=o.find(),r=t.find();eqPos(s.from,Pos(0,1)),eqPos(s.to,Pos(0,3)),eqPos(r.from,Pos(0,0)),eqPos(r.to,Pos(2,1)),eqPos(n.find(),Pos(1,5)),e.redo(),e.redo(),eq(n.find(),null),e.undo(),eqPos(n.find(),Pos(1,5)),eq(e.getValue(),a)},{value:"1234\n56789\n00\n"}),testCM("markTextStayGone",function(e){var o=e.markText(Pos(0,0),Pos(0,1));e.replaceRange("hi",Pos(0,2)),o.clear(),e.undo(),eq(o.find(),null)},{value:"hello"}),testCM("markTextAllowEmpty",function(e){var o=e.markText(Pos(0,1),Pos(0,2),{clearWhenEmpty:!1});is(o.find()),e.replaceRange("x",Pos(0,0)),is(o.find()),e.replaceRange("y",Pos(0,2)),is(o.find()),e.replaceRange("z",Pos(0,3),Pos(0,4)),is(!o.find());var t=e.markText(Pos(0,1),Pos(0,2),{clearWhenEmpty:!1,inclusiveLeft:!0,inclusiveRight:!0});e.replaceRange("q",Pos(0,1),Pos(0,2)),is(t.find()),e.replaceRange("",Pos(0,0),Pos(0,3)),is(!t.find());var n=e.markText(Pos(0,1),Pos(0,1),{clearWhenEmpty:!1});e.replaceRange("a",Pos(0,3)),is(n.find()),e.replaceRange("b",Pos(0,1)),is(!n.find())},{value:"abcde"}),testCM("markTextStacked",function(e){var o=e.markText(Pos(0,0),Pos(0,0),{clearWhenEmpty:!1}),t=e.markText(Pos(0,0),Pos(0,0),{clearWhenEmpty:!1});e.replaceRange("B",Pos(0,1)),is(o.find()&&t.find())},{value:"A"}),testCM("undoPreservesNewMarks",function(e){e.markText(Pos(0,3),Pos(0,4)),e.markText(Pos(1,1),Pos(1,3)),e.replaceRange("",Pos(0,3),Pos(3,1));var o=e.markText(Pos(0,0),Pos(0,1)),t=e.markText(Pos(0,5),Pos(0,6)),n=e.markText(Pos(0,2),Pos(0,4));e.undo(),eqPos(o.find().from,Pos(0,0)),eqPos(o.find().to,Pos(0,1)),eqPos(t.find().from,Pos(3,3)),eqPos(t.find().to,Pos(3,4)),eqPos(n.find().from,Pos(0,2)),eqPos(n.find().to,Pos(3,2));var a=e.findMarksAt(Pos(2,2));eq(a.length,1),eq(a[0],n)},{value:"aaaa\nbbbb\ncccc\ndddd"}),testCM("markClearBetween",function(e){e.setValue("aaa\nbbb\nccc\nddd\n"),e.markText(Pos(0,0),Pos(2)),e.replaceRange("aaa\nbbb\nccc",Pos(0,0),Pos(2)),eq(e.findMarksAt(Pos(1,1)).length,0)}),testCM("findMarksMiddle",function(e){var o=e.markText(Pos(1,1),Pos(3,1)),t=e.findMarks(Pos(2,1),Pos(2,2));eq(t.length,1),eq(t[0],o)},{value:"line 0\nline 1\nline 2\nline 3"}),testCM("deleteSpanCollapsedInclusiveLeft",function(e){var o=Pos(1,0),t=Pos(1,1);e.markText(o,t,{collapsed:!0,inclusiveLeft:!0});e.replaceRange("",o,t)},{value:"abc\nX\ndef"}),testCM("markTextCSS",function(e){function o(){for(var o=e.display.lineDiv.getElementsByTagName("span"),t=0;t<o.length;t++)if("cyan"==o[t].style.color&&"cdefg"==span[t].textContent)return!0}var t=e.markText(Pos(0,2),Pos(0,6),{css:"color: cyan"});t.clear(),is(!o())},{value:"abcdefgh"}),testCM("bookmark",function(e){function o(e){return e&&Pos(e[0],e[1])}forEach([{a:[1,0],b:[1,1],c:"",d:[1,4]},{a:[1,1],b:[1,1],c:"xx",d:[1,7]},{a:[1,4],b:[1,5],c:"ab",d:[1,6]},{a:[1,4],b:[1,6],c:"",d:null},{a:[1,5],b:[1,6],c:"abc",d:[1,5]},{a:[1,6],b:[1,8],c:"",d:[1,5]},{a:[1,4],b:[1,4],c:"\n\n",d:[3,1]},{bm:[1,9],a:[1,1],b:[1,1],c:"\n",d:[2,8]}],function(t){e.setValue("1234567890\n1234567890\n1234567890");var n=e.setBookmark(o(t.bm)||Pos(1,5));e.replaceRange(t.c,o(t.a),o(t.b)),eqPos(n.find(),o(t.d))})}),testCM("bookmarkInsertLeft",function(e){var o=e.setBookmark(Pos(0,2),{insertLeft:!1}),t=e.setBookmark(Pos(0,2),{insertLeft:!0});e.setCursor(Pos(0,2)),e.replaceSelection("hi"),eqPos(o.find(),Pos(0,2)),eqPos(t.find(),Pos(0,4)),e.replaceRange("",Pos(0,4),Pos(0,5)),e.replaceRange("",Pos(0,2),Pos(0,4)),e.replaceRange("",Pos(0,1),Pos(0,2)),eqPos(o.find(),Pos(0,1)),eqPos(t.find(),Pos(0,1))},{value:"abcdef"}),testCM("bookmarkCursor",function(e){var o=e.cursorCoords(Pos(0,1)),t=e.cursorCoords(Pos(1,1)),n=e.cursorCoords(Pos(2,0)),a=e.cursorCoords(Pos(3,0)),s=e.cursorCoords(Pos(4,1));e.setBookmark(Pos(0,1),{widget:document.createTextNode("←"),insertLeft:!0}),e.setBookmark(Pos(2,0),{widget:document.createTextNode("←"),insertLeft:!0}),e.setBookmark(Pos(1,1),{widget:document.createTextNode("→")}),e.setBookmark(Pos(3,0),{widget:document.createTextNode("→")});var r=e.cursorCoords(Pos(0,1)),i=e.cursorCoords(Pos(1,1)),l=e.cursorCoords(Pos(2,0)),c=e.cursorCoords(Pos(3,0));near(r.left,o.left,1),near(r.top,o.top,1),is(i.left>t.left,"at right, middle of line"),near(i.top==t.top,1),near(l.left,n.left,1),near(l.top,n.top,1),is(c.left>a.left,"at right, empty line"),near(c.top,a,1),e.setBookmark(Pos(4,0),{widget:document.createTextNode("→")}),is(e.cursorCoords(Pos(4,1)).left>s.left,"single-char bug")},{value:"foo\nbar\n\n\nx\ny"}),testCM("multiBookmarkCursor",function(e){function o(o){for(var t=0;3>t;++t){var a=document.createElement("span");a.innerHTML="X",n.push(e.setBookmark(Pos(0,1),{widget:a,insertLeft:o}))}}if(!phantom){var t,n=[],a=e.cursorCoords(Pos(0,1)).left,s=e.cursorCoords(Pos(0,4)).left;for(o(!0),near(a,e.cursorCoords(Pos(0,1)).left,1);t=n.pop();)t.clear();o(!1),near(s,e.cursorCoords(Pos(0,1)).left,1)}},{value:"abcdefg"}),testCM("getAllMarks",function(e){addDoc(e,10,10);var o=e.setBookmark(Pos(0,2)),t=(e.markText(Pos(0,2),Pos(3,2)),e.markText(Pos(1,2),Pos(1,8)));e.markText(Pos(8,0),Pos(9,0));eq(e.getAllMarks().length,4),o.clear(),t.clear(),eq(e.getAllMarks().length,2)}),testCM("setValueClears",function(e){e.addLineClass(0,"wrap","foo");var o=e.markText(Pos(0,0),Pos(1,1),{inclusiveLeft:!0,inclusiveRight:!0});e.setValue("foo"),is(!e.lineInfo(0).wrapClass),is(!o.find())},{value:"a\nb"}),testCM("bug577",function(e){e.setValue("a\nb"),e.clearHistory(),e.setValue("fooooo"),e.undo()}),testCM("scrollSnap",function(e){e.setSize(100,100),addDoc(e,200,200),e.setCursor(Pos(100,180));var o=e.getScrollInfo();is(o.left>0&&o.top>0),e.setCursor(Pos(0,0)),o=e.getScrollInfo(),is(0==o.left&&0==o.top,"scrolled clean to top"),e.setCursor(Pos(100,180)),e.setCursor(Pos(199,0)),o=e.getScrollInfo(),is(0==o.left&&o.top+2>o.height-e.getScrollerElement().clientHeight,"scrolled clean to bottom")}),testCM("scrollIntoView",function(e){function o(o,n,a){var s=Pos(o,n);e.scrollIntoView(s);var r=e.charCoords(s,"window");is(r.left>=t.left,a+" (left)"),is(r.right<=t.right,a+" (right)"),is(r.top>=t.top,a+" (top)"),is(r.bottom<=t.bottom,a+" (bottom)")}if(!phantom){var t=e.getWrapperElement().getBoundingClientRect();addDoc(e,200,200),o(199,199,"bottom right"),o(0,0,"top left"),o(100,100,"center"),o(199,0,"bottom left"),o(0,199,"top right"),o(100,100,"center again")}}),testCM("scrollBackAndForth",function(e){addDoc(e,1,200),e.operation(function(){e.scrollIntoView(Pos(199,0)),e.scrollIntoView(Pos(4,0))}),is(e.getScrollInfo().top>0)}),testCM("selectAllNoScroll",function(e){addDoc(e,1,200),e.execCommand("selectAll"),eq(e.getScrollInfo().top,0),e.setCursor(199),e.execCommand("selectAll"),is(e.getScrollInfo().top>0)}),testCM("selectionPos",function(e){if(!phantom&&"textarea"==e.getOption("inputStyle")){e.setSize(100,100),addDoc(e,200,100),e.setSelection(Pos(1,100),Pos(98,100));var o=e.charCoords(Pos(0,200),"local").left,t=(e.charCoords(Pos(99)).top-e.charCoords(Pos(0)).top)/100;e.scrollTo(0,0);for(var n,a,s,r=byClassName(e.getWrapperElement(),"CodeMirror-selected"),i=e.getWrapperElement().getBoundingClientRect(),l=0,c=r.length;c>l;++l){var d=r[l].getBoundingClientRect(),u=d.left-i.left<30,g=d.right-d.left,P=d.right-i.left>.8*o;u&&P?(n=!0,is(d.bottom-d.top>90*t,"middle high"),is(g>.9*o,"middle wide")):(is(g>.4*o,"top/bot wide enough"),is(.6*o>g,"top/bot slim enough"),u?(s=!0,is(d.top-i.top>96*t,"bot below")):P&&(a=!0,is(d.top-i.top<2.1*t,"top above")))}is(a&&s&&n,"all parts")}},null),testCM("restoreHistory",function(e){e.setValue("abc\ndef"),e.replaceRange("hello",Pos(1,0),Pos(1)),e.replaceRange("goop",Pos(0,0),Pos(0)),e.undo();var o=e.getValue(),t=e.getHistory();window.JSON&&(t=JSON.parse(JSON.stringify(t))),eq(o,"abc\nhello"),e.setValue(""),e.clearHistory(),eq(e.historySize().undo,0),e.setValue(o),e.setHistory(t),e.redo(),eq(e.getValue(),"goop\nhello"),e.undo(),e.undo(),eq(e.getValue(),"abc\ndef")}),testCM("doubleScrollbar",function(e){var o=document.body.appendChild(document.createElement("p"));o.style.cssText="height: 50px; overflow: scroll; width: 50px";var t=o.offsetWidth+1-o.clientWidth;if(document.body.removeChild(o),!(2>t)){e.setSize(null,100),addDoc(e,1,300);var n=e.getWrapperElement();is(n.offsetWidth-byClassName(n,"CodeMirror-lines")[0].offsetWidth<=1.5*t)}}),testCM("weirdLinebreaks",function(e){e.setValue("foo\nbar\rbaz\r\nquux\n\rplop"),is(e.getValue(),"foo\nbar\nbaz\nquux\n\nplop"),is(e.lineCount(),6),e.setValue("\n\n"),is(e.lineCount(),3)}),testCM("setSize",function(e){e.setSize(100,100);var o=e.getWrapperElement();is(o.offsetWidth,100),is(o.offsetHeight,100),e.setSize("100%","3em"),is(o.style.width,"100%"),is(o.style.height,"3em"),e.setSize(null,40),is(o.style.width,"100%"),is(o.style.height,"40px")}),testCM("collapsedLines",function(e){addDoc(e,4,10);var o=foldLines(e,4,5),t=0;CodeMirror.on(o,"clear",function(){t++}),e.setCursor(Pos(3,0)),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(5,0)),e.replaceRange("abcdefg",Pos(3,0),Pos(3)),e.setCursor(Pos(3,6)),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(5,4)),e.replaceRange("ab",Pos(3,0),Pos(3)),e.setCursor(Pos(3,2)),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(5,2)),e.operation(function(){o.clear(),o.clear()}),eq(t,1)}),testCM("collapsedRangeCoordsChar",function(e){var o=e.charCoords(Pos(1,3));o.left+=2,o.top+=2;var t={collapsed:!0,inclusiveLeft:!0,inclusiveRight:!0},n=e.markText(Pos(0,0),Pos(2,0),t);eqPos(e.coordsChar(o),Pos(3,3)),n.clear();var n=e.markText(Pos(0,0),Pos(1,1),{collapsed:!0,inclusiveLeft:!0}),a=e.markText(Pos(1,1),Pos(2,0),{collapsed:!0,inclusiveRight:!0});eqPos(e.coordsChar(o),Pos(3,3)),n.clear(),a.clear();var n=e.markText(Pos(0,0),Pos(1,6),t);eqPos(e.coordsChar(o),Pos(3,3))},{value:"123456\nabcdef\nghijkl\nmnopqr\n"}),testCM("collapsedRangeBetweenLinesSelected",function(e){if("textarea"==e.getOption("inputStyle")){var o=document.createElement("span");o.textContent="↔",e.markText(Pos(0,3),Pos(1,0),{replacedWith:o}),e.setSelection(Pos(0,3),Pos(1,0));for(var t=byClassName(e.getWrapperElement(),"CodeMirror-selected"),n=0,a=0;n<t.length;n++)a+=t[n].offsetWidth;is(a>0)}},{value:"one\ntwo"}),testCM("randomCollapsedRanges",function(e){addDoc(e,20,500),e.operation(function(){for(var o=0;200>o;o++){var t=Pos(Math.floor(500*Math.random()),Math.floor(20*Math.random()));if(o%4)try{e.markText(t,Pos(t.line+2,1),{collapsed:!0})}catch(n){if(!/overlapping/.test(String(n)))throw n}else e.markText(t,Pos(t.line,t.ch+4),{className:"foo"})}})}),testCM("hiddenLinesAutoUnfold",function(e){var o=foldLines(e,1,3,!0),t=0;CodeMirror.on(o,"clear",function(){t++}),e.setCursor(Pos(3,0)),eq(t,0),e.execCommand("goCharLeft"),eq(t,1),o=foldLines(e,1,3,!0),CodeMirror.on(o,"clear",function(){t++}),eqPos(e.getCursor(),Pos(3,0)),e.setCursor(Pos(0,3)),e.execCommand("goCharRight"),eq(t,2)},{value:"abc\ndef\nghi\njkl"}),testCM("hiddenLinesSelectAll",function(e){addDoc(e,4,20),foldLines(e,0,10),foldLines(e,11,20),CodeMirror.commands.selectAll(e),eqPos(e.getCursor(!0),Pos(10,0)),eqPos(e.getCursor(!1),Pos(10,4))}),testCM("everythingFolded",function(e){function o(){e.triggerOnKeyDown({type:"keydown",keyCode:13,preventDefault:function(){},stopPropagation:function(){}})}addDoc(e,2,2);var t=foldLines(e,0,2);o(),eq(e.getValue(),"xx\nxx"),t.clear(),t=foldLines(e,0,2,!0),eq(t.find(),null),o(),eq(e.getValue(),"\nxx\nxx")}),testCM("structuredFold",function(e){if(!phantom){addDoc(e,4,8);var o=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("Q")});e.setCursor(0,3),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(6,2)),CodeMirror.commands.goCharLeft(e),eqPos(e.getCursor(),Pos(1,2)),CodeMirror.commands.delCharAfter(e),eq(e.getValue(),"xxxx\nxxxx\nxxxx"),addDoc(e,4,8),o=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("M"),clearOnEnter:!0});var t=0;CodeMirror.on(o,"clear",function(){++t}),e.setCursor(0,3),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(6,2)),CodeMirror.commands.goCharLeft(e),eqPos(e.getCursor(),Pos(6,1)),eq(t,1),o.clear(),eq(t,1),o=e.markText(Pos(1,2),Pos(6,2),{replacedWith:document.createTextNode("Q"),clearOnEnter:!0}),o.clear(),e.setCursor(1,2),CodeMirror.commands.goCharRight(e),eqPos(e.getCursor(),Pos(1,3)),o=e.markText(Pos(2,0),Pos(4,4),{replacedWith:document.createTextNode("M")}),e.setCursor(1,0),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(2,0))}},null),testCM("nestedFold",function(e){function o(o,t,n,a){return e.markText(Pos(o,t),Pos(n,a),{collapsed:!0})}addDoc(e,10,3);var t=(o(0,6,1,3),o(0,2,1,8)),n=o(0,1,2,3),a=o(0,5,0,6);e.setCursor(0,1),CodeMirror.commands.goCharRight(e),eqPos(e.getCursor(),Pos(2,3)),a.clear(),CodeMirror.commands.goCharLeft(e),eqPos(e.getCursor(),Pos(0,1)),n.clear(),CodeMirror.commands.goCharRight(e),eqPos(e.getCursor(),Pos(0,2)),CodeMirror.commands.goCharRight(e),eqPos(e.getCursor(),Pos(1,8)),t.clear(),CodeMirror.commands.goCharLeft(e),eqPos(e.getCursor(),Pos(1,7)),e.setCursor(0,5),CodeMirror.commands.goCharRight(e),eqPos(e.getCursor(),Pos(0,6)),CodeMirror.commands.goCharRight(e),eqPos(e.getCursor(),Pos(1,3))}),testCM("badNestedFold",function(e){addDoc(e,4,4),e.markText(Pos(0,2),Pos(3,2),{collapsed:!0});var o;try{e.markText(Pos(0,1),Pos(0,3),{collapsed:!0})}catch(t){o=t}is(o instanceof Error,"no error"),is(/overlap/i.test(o.message),"wrong error")}),testCM("nestedFoldOnSide",function(e){var o=e.markText(Pos(0,1),Pos(2,1),{collapsed:!0,inclusiveRight:!0});e.markText(Pos(0,1),Pos(0,2),{collapsed:!0});e.markText(Pos(0,1),Pos(0,2),{collapsed:!0}).clear();try{e.markText(Pos(0,1),Pos(0,2),{collapsed:!0,inclusiveLeft:!0})}catch(t){var n=t}is(n&&/overlap/i.test(n.message));var a=(e.markText(Pos(2,0),Pos(2,1),{collapsed:!0}),e.markText(Pos(2,0),Pos(2,1),{collapse:!0,inclusiveRight:!0}));o.clear(),a.clear(),o=e.markText(Pos(0,1),Pos(2,1),{collapsed:!0}),e.markText(Pos(2,0),Pos(2,1),{collapsed:!0}).clear();try{e.markText(Pos(2,0),Pos(2,1),{collapsed:!0,inclusiveRight:!0})}catch(t){var n=t}is(n&&/overlap/i.test(n.message))},{value:"ab\ncdef"}),testCM("editInFold",function(e){addDoc(e,4,6);e.markText(Pos(1,2),Pos(3,2),{collapsed:!0});e.replaceRange("",Pos(0,0),Pos(1,3)),e.replaceRange("",Pos(2,1),Pos(3,3)),e.replaceRange("a\nb\nc\nd",Pos(0,1),Pos(1,0)),e.cursorCoords(Pos(0,0))}),testCM("wrappingInlineWidget",function(e){e.setSize("11em");var o=document.createElement("span");o.style.color="red",o.innerHTML="one two three four",e.markText(Pos(0,6),Pos(0,9),{replacedWith:o});var t=e.cursorCoords(Pos(0,0)),n=e.cursorCoords(Pos(0,10));is(t.top<n.top),is(t.bottom<n.bottom);var a=e.cursorCoords(Pos(0,6)),s=e.cursorCoords(Pos(0,9));eq(a.top,t.top),eq(a.bottom,t.bottom),eq(s.top,n.top),eq(s.bottom,n.bottom),e.replaceRange("",Pos(0,9),Pos(0)),s=e.cursorCoords(Pos(0,9)),phantom||(eq(s.top,n.top),eq(s.bottom,n.bottom))},{value:"1 2 3 xxx 4",lineWrapping:!0}),testCM("showEmptyWidgetSpan",function(e){e.markText(Pos(0,2),Pos(0,2),{clearWhenEmpty:!1,replacedWith:document.createTextNode("X")});eq(e.display.view[0].text.textContent,"abXc")},{value:"abc"}),testCM("changedInlineWidget",function(e){e.setSize("10em");var o=document.createElement("span");o.innerHTML="x";var t=e.markText(Pos(0,4),Pos(0,5),{replacedWith:o});o.innerHTML="and now the widget is really really long all of a sudden and a scrollbar is needed",t.changed();var n=byClassName(e.getWrapperElement(),"CodeMirror-hscrollbar")[0];is(n.scrollWidth>n.clientWidth)},{value:"hello there"}),testCM("changedBookmark",function(e){e.setSize("10em");var o=document.createElement("span");o.innerHTML="x";var t=e.setBookmark(Pos(0,4),{widget:o});o.innerHTML="and now the widget is really really long all of a sudden and a scrollbar is needed",t.changed();var n=byClassName(e.getWrapperElement(),"CodeMirror-hscrollbar")[0];is(n.scrollWidth>n.clientWidth)},{value:"abcdefg"}),testCM("inlineWidget",function(e){var o=e.setBookmark(Pos(0,2),{widget:document.createTextNode("uu")});e.setCursor(0,2),CodeMirror.commands.goLineDown(e),eqPos(e.getCursor(),Pos(1,4)),e.setCursor(0,2),e.replaceSelection("hi"),eqPos(o.find(),Pos(0,2)),e.setCursor(0,1),e.replaceSelection("ay"),eqPos(o.find(),Pos(0,4)),eq(e.getLine(0),"uayuhiuu")},{value:"uuuu\nuuuuuu"}),testCM("wrappingAndResizing",function(e){e.setSize(null,"auto"),e.setOption("lineWrapping",!0);var o=e.getWrapperElement(),t=o.offsetHeight,n="xxx xxx xxx xxx xxx";e.setValue(n);for(var a=10,s=e.charCoords(Pos(0,18),"div").right;;s+=a)if(e.setSize(s),o.offsetHeight<=t*(opera_lt10?1.2:1.5)){if(10!=a)break;s-=10,a=1}e.setCursor(Pos(0,n.length)),eq(o.offsetHeight,t),e.replaceSelection("x"),is(o.offsetHeight>t,"wrapping happens"),e.setValue(n+"\n"+n+"\n"),e.getScrollerElement().style.maxHeight="100px",e.replaceRange("\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n!\n",Pos(2,0)),forEach([Pos(0,n.length),Pos(0,n.length-1),Pos(0,0),Pos(1,n.length),Pos(1,n.length-1)],function(o){var t=e.charCoords(o);eqPos(o,e.coordsChar({left:t.left+2,top:t.top+5}))})},null,ie_lt8),testCM("measureEndOfLine",function(e){e.setSize(null,"auto");for(var o=byClassName(e.getWrapperElement(),"CodeMirror-lines")[0].firstChild,t=o.offsetHeight,n=10,a=e.charCoords(Pos(0,7),"div").right;;a+=n)if(e.setSize(a),o.offsetHeight<2.5*t){if(10!=n)break;a-=10,n=1}e.setValue(e.getValue()+"\n\n");var s=e.charCoords(Pos(0,18),"local");is(s.top>.8*t,"not at top"),is(s.left>a-20,"not at right"),s=e.charCoords(Pos(0,18)),eqPos(e.coordsChar({left:s.left,top:s.top+5}),Pos(0,18))},{mode:"text/html",value:"<!-- foo barrr -->",lineWrapping:!0},ie_lt8||opera_lt10),testCM("scrollVerticallyAndHorizontally",function(e){if("textarea"==e.getOption("inputStyle")){e.setSize(100,100),addDoc(e,40,40),e.setCursor(39);var o=e.getWrapperElement(),t=byClassName(o,"CodeMirror-vscrollbar")[0];is(t.offsetHeight<o.offsetHeight,"vertical scrollbar limited by horizontal one");var n=byClassName(o,"CodeMirror-cursor")[0].getBoundingClientRect(),a=o.getBoundingClientRect();is(n.bottom<a.top+e.getScrollerElement().clientHeight,"bottom line visible")}},{lineNumbers:!0}),testCM("moveVstuck",function(e){var o=byClassName(e.getWrapperElement(),"CodeMirror-lines")[0].firstChild,t=o.offsetHeight,n="fooooooooooooooooooooooooo baaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaar\n";e.setValue(n);for(var a=2.8*e.charCoords(Pos(0,26),"div").right;e.setSize(a),!(o.offsetHeight<=3.5*t);a+=5);e.setCursor(Pos(0,n.length-1)),e.moveV(-1,"line"),eqPos(e.getCursor(),Pos(0,26))},{lineWrapping:!0},ie_lt8||opera_lt10),testCM("collapseOnMove",function(e){e.setSelection(Pos(0,1),Pos(2,4)),e.execCommand("goLineUp"),is(!e.somethingSelected()),eqPos(e.getCursor(),Pos(0,1)),e.setSelection(Pos(0,1),Pos(2,4)),e.execCommand("goPageDown"),is(!e.somethingSelected()),eqPos(e.getCursor(),Pos(2,4)),e.execCommand("goLineUp"),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(0,4)),e.setSelection(Pos(0,1),Pos(2,4)),e.execCommand("goCharLeft"),is(!e.somethingSelected()),eqPos(e.getCursor(),Pos(0,1))},{value:"aaaaa\nb\nccccc"}),testCM("clickTab",function(e){var o=e.charCoords(Pos(0,0));eqPos(e.coordsChar({left:o.left+5,top:o.top+5}),Pos(0,0)),eqPos(e.coordsChar({left:o.right-5,top:o.top+5}),Pos(0,1))},{value:"	\n\n",lineWrapping:!0,tabSize:8}),testCM("verticalScroll",function(e){e.setSize(100,200),e.setValue("foo\nbar\nbaz\n");var o=e.getScrollerElement(),t=o.scrollWidth;e.replaceRange("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah",Pos(0,0),Pos(0)),is(o.scrollWidth>t,"scrollbar present"),e.replaceRange("foo",Pos(0,0),Pos(0)),phantom||eq(o.scrollWidth,t,"scrollbar gone"),e.replaceRange("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaah",Pos(0,0),Pos(0)),e.replaceRange("bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbh",Pos(1,0),Pos(1)),is(o.scrollWidth>t,"present again");var n=o.scrollWidth;e.replaceRange("foo",Pos(0,0),Pos(0)),is(o.scrollWidth<n,"scrollbar smaller"),is(o.scrollWidth>t,"but still present")}),testCM("extraKeys",function(e){function o(o,n,a){"string"==typeof n&&(n=n.charCodeAt(0));var s={type:"keydown",keyCode:n,preventDefault:function(){},stopPropagation:function(){}};if(a)for(var r in a)s[r]=a[r];t=null,e.triggerOnKeyDown(s),eq(t,o)}var t;CodeMirror.commands.testCommand=function(){t="tc"},CodeMirror.commands.goTestCommand=function(){t="gtc"},e.setOption("extraKeys",{"Shift-X":function(){t="sx"},X:function(){t="x"},"Ctrl-Alt-U":function(){t="cau"},End:"testCommand",Home:"goTestCommand",Tab:!1}),o(null,"U"),o("cau","U",{ctrlKey:!0,altKey:!0}),o(null,"U",{shiftKey:!0,ctrlKey:!0,altKey:!0}),o("x","X"),o("sx","X",{shiftKey:!0}),o("tc",35),o(null,35,{shiftKey:!0}),o("gtc",36),o("gtc",36,{shiftKey:!0}),o(null,9)},null,window.opera&&mac),testCM("wordMovementCommands",function(e){e.execCommand("goWordLeft"),eqPos(e.getCursor(),Pos(0,0)),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(0,7)),
e.execCommand("goWordLeft"),eqPos(e.getCursor(),Pos(0,5)),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(0,12)),e.execCommand("goWordLeft"),eqPos(e.getCursor(),Pos(0,9)),e.execCommand("goWordRight"),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(0,24)),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(1,9)),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(1,13)),e.execCommand("goWordRight"),e.execCommand("goWordRight"),eqPos(e.getCursor(),Pos(2,0))},{value:"this is (the) firstline.\na foo12éø×bar\n"}),testCM("groupMovementCommands",function(e){e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(0,0)),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(0,4)),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(0,7)),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(0,10)),e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(0,7)),e.execCommand("goGroupRight"),e.execCommand("goGroupRight"),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(0,15)),e.setCursor(Pos(0,17)),e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(0,16)),e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(0,14)),e.execCommand("goGroupRight"),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(0,20)),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(1,0)),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(1,2)),e.execCommand("goGroupRight"),eqPos(e.getCursor(),Pos(1,5)),e.execCommand("goGroupLeft"),e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(1,0)),e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(0,20)),e.execCommand("goGroupLeft"),eqPos(e.getCursor(),Pos(0,16))},{value:"booo ba---quux. ffff\n  abc d"}),testCM("groupsAndWhitespace",function(e){for(var o=[Pos(0,0),Pos(0,2),Pos(0,5),Pos(0,9),Pos(0,11),Pos(1,0),Pos(1,2),Pos(1,5)],t=1;t<o.length;t++)e.execCommand("goGroupRight"),eqPos(e.getCursor(),o[t]);for(var t=o.length-2;t>=0;t--)e.execCommand("goGroupLeft"),eqPos(e.getCursor(),2==t?Pos(0,6):o[t])},{value:"  foo +++  \n  bar"}),testCM("charMovementCommands",function(e){e.execCommand("goCharLeft"),e.execCommand("goColumnLeft"),eqPos(e.getCursor(),Pos(0,0)),e.execCommand("goCharRight"),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(0,2)),e.setCursor(Pos(1,0)),e.execCommand("goColumnLeft"),eqPos(e.getCursor(),Pos(1,0)),e.execCommand("goCharLeft"),eqPos(e.getCursor(),Pos(0,5)),e.execCommand("goColumnRight"),eqPos(e.getCursor(),Pos(0,5)),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(1,0)),e.execCommand("goLineEnd"),eqPos(e.getCursor(),Pos(1,5)),e.execCommand("goLineStartSmart"),eqPos(e.getCursor(),Pos(1,1)),e.execCommand("goLineStartSmart"),eqPos(e.getCursor(),Pos(1,0)),e.setCursor(Pos(2,0)),e.execCommand("goCharRight"),e.execCommand("goColumnRight"),eqPos(e.getCursor(),Pos(2,0))},{value:"line1\n ine2\n"}),testCM("verticalMovementCommands",function(e){e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(0,0)),e.execCommand("goLineDown"),phantom||eqPos(e.getCursor(),Pos(1,0)),e.setCursor(Pos(1,12)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(2,5)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(3,0)),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(2,5)),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(1,12)),e.execCommand("goPageDown"),eqPos(e.getCursor(),Pos(5,0)),e.execCommand("goPageDown"),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(5,0)),e.execCommand("goPageUp"),eqPos(e.getCursor(),Pos(0,0))},{value:"line1\nlong long line2\nline3\n\nline5\n"}),testCM("verticalMovementCommandsWrapping",function(e){e.setSize(120),e.setCursor(Pos(0,5)),e.execCommand("goLineDown"),eq(e.getCursor().line,0),is(e.getCursor().ch>5,"moved beyond wrap");for(var o=0;;++o){is(20>o,"no endless loop"),e.execCommand("goLineDown");var t=e.getCursor();if(1==t.line&&eq(t.ch,5),2==t.line){eq(t.ch,1);break}}},{value:"a very long line that wraps around somehow so that we can test cursor movement\nshortone\nk",lineWrapping:!0}),testCM("rtlMovement",function(e){"textarea"==e.getOption("inputStyle")&&forEach(["خحج","خحabcخحج","abخحخحجcd","abخde","abخح2342خ1حج","خ1ح2خح3حxج","خحcd","1خحcd","abcdeح1ج","خمرحبها مها!","foobarر","خ ة ق",'<img src="/בדיקה3.jpg">',"يتم السحب في 05 فبراير 2014"],function(o){var t=o.charCodeAt(0)>128;e.setValue(o+"\n"),e.execCommand(t?"goLineEnd":"goLineStart");for(var n=byClassName(e.getWrapperElement(),"CodeMirror-cursors")[0],a=n.firstChild,s=a.offsetLeft,r=a.offsetTop,i=0;i<=o.length;++i)e.execCommand("goCharRight"),a=n.firstChild,i==o.length?is(a.offsetTop>r,"next line"):is(a.offsetLeft>s,"moved right"),s=a.offsetLeft,r=a.offsetTop;e.setCursor(0,0),e.execCommand(t?"goLineStart":"goLineEnd"),s=n.firstChild.offsetLeft;for(var i=0;i<o.length;++i)e.execCommand("goCharLeft"),a=n.firstChild,is(a.offsetLeft<s,"moved left"),s=a.offsetLeft})},null,ie_lt9),testCM("bidiUpdate",function(e){e.setCursor(Pos(0,2)),e.replaceSelection("خحج","start"),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(0,4))},{value:"abcd\n"}),testCM("movebyTextUnit",function(e){e.setValue("בְּרֵאשִ\nééé́\n"),e.execCommand("goLineEnd");for(var o=0;4>o;++o)e.execCommand("goCharRight");eqPos(e.getCursor(),Pos(0,0)),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(1,0)),e.execCommand("goCharRight"),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(1,4)),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(1,7))}),testCM("lineChangeEvents",function(e){addDoc(e,3,5);for(var o=[],t=["ch 0","ch 1","del 2","ch 0","ch 0","del 1","del 3","del 4"],n=0;5>n;++n)CodeMirror.on(e.getLineHandle(n),"delete",function(e){return function(){o.push("del "+e)}}(n)),CodeMirror.on(e.getLineHandle(n),"change",function(e){return function(){o.push("ch "+e)}}(n));e.replaceRange("x",Pos(0,1)),e.replaceRange("xy",Pos(1,1),Pos(2)),e.replaceRange("foo\nbar",Pos(0,1)),e.replaceRange("",Pos(0,0),Pos(e.lineCount())),eq(o.length,t.length,"same length");for(var n=0;n<o.length;++n)eq(o[n],t[n])}),testCM("scrollEntirelyToRight",function(e){if(!phantom&&"textarea"==e.getOption("inputStyle")){addDoc(e,500,2),e.setCursor(Pos(0,500));var o=e.getWrapperElement(),t=byClassName(o,"CodeMirror-cursor")[0];is(o.getBoundingClientRect().right>t.getBoundingClientRect().left)}}),testCM("lineWidgets",function(e){addDoc(e,500,3);var o=e.charCoords(Pos(2,0)),t=document.createElement("div");t.innerHTML="hi";e.addLineWidget(1,t);is(o.top<e.charCoords(Pos(2,0)).top,"took up space"),e.setCursor(Pos(1,1)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(2,1)),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(1,1))}),testCM("lineWidgetFocus",function(e){var o=document.getElementById("testground");o.className="offscreen";try{addDoc(e,500,10);var t=document.createElement("input");e.addLineWidget(1,t);t.focus(),eq(document.activeElement,t),e.replaceRange("new stuff",Pos(1,0)),eq(document.activeElement,t)}finally{o.className=""}}),testCM("lineWidgetCautiousRedraw",function(e){var o=document.createElement("div");o.innerHTML="hahah";var t=e.addLineWidget(0,o),n=!1;t.on("redraw",function(){n=!0}),e.replaceSelection("0"),is(!n)},{value:"123\n456"});var knownScrollbarWidth;testCM("lineWidgetChanged",function(e){function o(){var e=document.createElement("div"),o='<div style="display: inline-block; height: 1px; width: '+(285-t)+'px;"></div>',s='<div style="display: inline-block; height: 1px; width: '+(305-t)+'px;"></div>';return e.innerHTML=new Array(3).join(o)+new Array(3).join(s),e.style.cssText="background: yellow;font-size:0;line-height: "+n/a+"px;",e}addDoc(e,2,300);var t=scrollbarWidth(e.display.measure)/2;e.setOption("lineNumbers",!0),e.setSize(600,50*e.defaultTextHeight()),e.scrollTo(null,e.heightAtLine(125,"local"));var n=60,a=3,s=e.getScrollInfo(),r=e.addLineWidget(0,o(),{coverGutter:!0}),i=e.addLineWidget(150,o(),{coverGutter:!0}),l=e.addLineWidget(300,o(),{coverGutter:!0}),c=e.getScrollInfo();eq(s.height+3*n,c.height),eq(s.top+n,c.top),n=12,r.node.style.lineHeight=i.node.style.lineHeight=l.node.style.lineHeight=n/a+"px",r.changed(),i.changed(),l.changed();var d=e.getScrollInfo();eq(s.height+3*n,d.height),eq(s.top+n,d.top)}),testCM("getLineNumber",function(e){addDoc(e,2,20);var o=e.getLineHandle(1);eq(e.getLineNumber(o),1),e.replaceRange("hi\nbye\n",Pos(0,0)),eq(e.getLineNumber(o),3),e.setValue(""),eq(e.getLineNumber(o),null)}),testCM("jumpTheGap",function(e){if(!phantom){var o="abcdef ghiklmnop qrstuvw xyz ";o+=o,o+=o,o+=o,e.replaceRange(o,Pos(2,0),Pos(2)),e.setSize("200px",null),e.getWrapperElement().style.lineHeight=2,e.refresh(),e.setCursor(Pos(0,1)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(1,1)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(2,1)),e.execCommand("goLineDown"),eq(e.getCursor().line,2),is(e.getCursor().ch>1),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(2,1)),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(1,1));var t=document.createElement("div");t.innerHTML="hi",t.style.height="30px",e.addLineWidget(0,t),e.addLineWidget(1,t.cloneNode(!0),{above:!0}),e.setCursor(Pos(0,2)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(1,2)),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(0,2))}},{lineWrapping:!0,value:"abc\ndef\nghi\njkl\n"}),testCM("addLineClass",function(e){function o(o,t,n,a,s){var r=e.lineInfo(o);eq(r.textClass,t),eq(r.bgClass,n),eq(r.wrapClass,a),"undefined"!=typeof r.handle.gutterClass&&eq(r.handle.gutterClass,s)}e.addLineClass(0,"text","foo"),e.addLineClass(0,"text","bar"),e.addLineClass(1,"background","baz"),e.addLineClass(1,"wrap","foo"),e.addLineClass(1,"gutter","gutter-class"),o(0,"foo bar",null,null,null),o(1,null,"baz","foo","gutter-class");var t=e.display.lineDiv;eq(byClassName(t,"foo").length,2),eq(byClassName(t,"bar").length,1),eq(byClassName(t,"baz").length,1),eq(byClassName(t,"gutter-class").length,2),e.removeLineClass(0,"text","foo"),o(0,"bar",null,null,null),e.removeLineClass(0,"text","foo"),o(0,"bar",null,null,null),e.removeLineClass(0,"text","bar"),o(0,null,null,null),e.addLineClass(1,"wrap","quux"),o(1,null,"baz","foo quux","gutter-class"),e.removeLineClass(1,"wrap"),o(1,null,"baz",null,"gutter-class"),e.removeLineClass(1,"gutter","gutter-class"),eq(byClassName(t,"gutter-class").length,0),o(1,null,"baz",null,null),e.addLineClass(1,"gutter","gutter-class"),o(1,null,"baz",null,"gutter-class"),e.removeLineClass(1,"gutter","gutter-class"),o(1,null,"baz",null,null)},{value:"hohoho\n",lineNumbers:!0}),testCM("atomicMarker",function(e){function o(o,t,n,a,s,r){return e.markText(Pos(o,t),Pos(n,a),{atomic:!0,inclusiveLeft:s,inclusiveRight:r})}addDoc(e,10,10);var t=o(0,1,0,5);e.setCursor(Pos(0,1)),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(0,5)),e.execCommand("goCharLeft"),eqPos(e.getCursor(),Pos(0,1)),t.clear(),t=o(0,0,0,5,!0),eqPos(e.getCursor(),Pos(0,5),"pushed out"),e.execCommand("goCharLeft"),eqPos(e.getCursor(),Pos(0,5)),t.clear(),t=o(8,4,9,10,!1,!0),e.setCursor(Pos(9,8)),eqPos(e.getCursor(),Pos(8,4),"set"),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(8,4),"char right"),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(8,4),"line down"),e.execCommand("goCharLeft"),eqPos(e.getCursor(),Pos(8,3)),t.clear(),t=o(1,1,3,8),e.setCursor(Pos(0,0)),e.setCursor(Pos(2,0)),eqPos(e.getCursor(),Pos(3,8)),e.execCommand("goCharLeft"),eqPos(e.getCursor(),Pos(1,1)),e.execCommand("goCharRight"),eqPos(e.getCursor(),Pos(3,8)),e.execCommand("goLineUp"),eqPos(e.getCursor(),Pos(1,1)),e.execCommand("goLineDown"),eqPos(e.getCursor(),Pos(3,8)),e.execCommand("delCharBefore"),eq(e.getValue().length,80,"del chunk"),t=o(3,0,5,5),e.setCursor(Pos(3,0)),e.execCommand("delWordAfter"),eq(e.getValue().length,53,"del chunk")}),testCM("selectionBias",function(e){e.markText(Pos(0,1),Pos(0,3),{atomic:!0}),e.setCursor(Pos(0,2)),eqPos(e.getCursor(),Pos(0,1)),e.setCursor(Pos(0,2)),eqPos(e.getCursor(),Pos(0,3)),e.setCursor(Pos(0,2)),eqPos(e.getCursor(),Pos(0,1)),e.setCursor(Pos(0,2),null,{bias:-1}),eqPos(e.getCursor(),Pos(0,1)),e.setCursor(Pos(0,4)),e.setCursor(Pos(0,2),null,{bias:1}),eqPos(e.getCursor(),Pos(0,3))},{value:"12345"}),testCM("selectionHomeEnd",function(e){e.markText(Pos(1,0),Pos(1,1),{atomic:!0,inclusiveLeft:!0}),e.markText(Pos(1,3),Pos(1,4),{atomic:!0,inclusiveRight:!0}),e.setCursor(Pos(1,2)),e.execCommand("goLineStart"),eqPos(e.getCursor(),Pos(1,1)),e.execCommand("goLineEnd"),eqPos(e.getCursor(),Pos(1,3))},{value:"ab\ncdef\ngh"}),testCM("readOnlyMarker",function(e){function o(o,t,n,a,s){return e.markText(Pos(o,t),Pos(n,a),{readOnly:!0,atomic:s})}var t=o(0,1,0,4);e.setCursor(Pos(0,2)),e.replaceSelection("hi","end"),eqPos(e.getCursor(),Pos(0,2)),eq(e.getLine(0),"abcde"),e.execCommand("selectAll"),e.replaceSelection("oops","around"),eq(e.getValue(),"oopsbcd"),e.undo(),eqPos(t.find().from,Pos(0,1)),eqPos(t.find().to,Pos(0,4)),t.clear(),e.setCursor(Pos(0,2)),e.replaceSelection("hi","around"),eq(e.getLine(0),"abhicde"),eqPos(e.getCursor(),Pos(0,4)),t=o(0,2,2,2,!0),e.setSelection(Pos(1,1),Pos(2,4)),e.replaceSelection("t","end"),eqPos(e.getCursor(),Pos(2,3)),eq(e.getLine(2),"klto"),e.execCommand("goCharLeft"),e.execCommand("goCharLeft"),eqPos(e.getCursor(),Pos(0,2)),e.setSelection(Pos(0,1),Pos(0,3)),e.replaceSelection("xx","around"),eqPos(e.getCursor(),Pos(0,3)),eq(e.getLine(0),"axxhicde")},{value:"abcde\nfghij\nklmno\n"}),testCM("dirtyBit",function(e){eq(e.isClean(),!0),e.replaceSelection("boo",null,"test"),eq(e.isClean(),!1),e.undo(),eq(e.isClean(),!0),e.replaceSelection("boo",null,"test"),e.replaceSelection("baz",null,"test"),e.undo(),eq(e.isClean(),!1),e.markClean(),eq(e.isClean(),!0),e.undo(),eq(e.isClean(),!1),e.redo(),eq(e.isClean(),!0)}),testCM("changeGeneration",function(e){e.replaceSelection("x");var o=e.changeGeneration();e.replaceSelection("x"),e.undo(),eq(e.getValue(),""),is(!e.isClean(o)),e.replaceSelection("x");var t=e.changeGeneration(!0);e.replaceSelection("x"),e.undo(),eq(e.getValue(),"x"),is(e.isClean(t))}),testCM("addKeyMap",function(e){function o(o){e.triggerOnKeyDown({type:"keydown",keyCode:o,preventDefault:function(){},stopPropagation:function(){}})}o(39),eqPos(e.getCursor(),Pos(0,1));var t=0,n={Right:function(){++t}},a={Right:function(){t+=10}};e.addKeyMap(n),o(39),eqPos(e.getCursor(),Pos(0,1)),eq(t,1),e.addKeyMap(a,!0),o(39),eq(t,2),e.removeKeyMap(n),o(39),eq(t,12),e.removeKeyMap(a),o(39),eq(t,12),eqPos(e.getCursor(),Pos(0,2)),e.addKeyMap({Right:function(){t=55},name:"mymap"}),o(39),eq(t,55),e.removeKeyMap("mymap"),o(39),eqPos(e.getCursor(),Pos(0,3))},{value:"abc"}),testCM("findPosH",function(e){forEach([{from:Pos(0,0),to:Pos(0,1),by:1},{from:Pos(0,0),to:Pos(0,0),by:-1,hitSide:!0},{from:Pos(0,0),to:Pos(0,4),by:1,unit:"word"},{from:Pos(0,0),to:Pos(0,8),by:2,unit:"word"},{from:Pos(0,0),to:Pos(2,0),by:20,unit:"word",hitSide:!0},{from:Pos(0,7),to:Pos(0,5),by:-1,unit:"word"},{from:Pos(0,4),to:Pos(0,8),by:1,unit:"word"},{from:Pos(1,0),to:Pos(1,18),by:3,unit:"word"},{from:Pos(1,22),to:Pos(1,5),by:-3,unit:"word"},{from:Pos(1,15),to:Pos(1,10),by:-5},{from:Pos(1,15),to:Pos(1,10),by:-5,unit:"column"},{from:Pos(1,15),to:Pos(1,0),by:-50,unit:"column",hitSide:!0},{from:Pos(1,15),to:Pos(1,24),by:50,unit:"column",hitSide:!0},{from:Pos(1,15),to:Pos(2,0),by:50,hitSide:!0}],function(o){var t=e.findPosH(o.from,o.by,o.unit||"char");eqPos(t,o.to),eq(!!t.hitSide,!!o.hitSide)})},{value:"line one\nline two.something.other\n"}),testCM("beforeChange",function(e){e.on("beforeChange",function(e,o){for(var t=[],n=0;n<o.text.length;++n)t.push(o.text[n].replace(/\s/g,"_"));o.update(null,null,t)}),e.setValue("hello, i am a\nnew document\n"),eq(e.getValue(),"hello,_i_am_a\nnew_document\n"),CodeMirror.on(e.getDoc(),"beforeChange",function(e,o){0==o.from.line&&o.cancel()}),e.setValue("oops"),eq(e.getValue(),"hello,_i_am_a\nnew_document\n"),e.replaceRange("hey hey hey",Pos(1,0),Pos(2,0)),eq(e.getValue(),"hello,_i_am_a\nhey_hey_hey")},{value:"abcdefghijk"}),testCM("beforeChangeUndo",function(e){e.replaceRange("hi",Pos(0,0),Pos(0)),e.replaceRange("bye",Pos(0,0),Pos(0)),eq(e.historySize().undo,2),e.on("beforeChange",function(e,o){is(!o.update),o.cancel()}),e.undo(),eq(e.historySize().undo,0),eq(e.getValue(),"bye\ntwo")},{value:"one\ntwo"}),testCM("beforeSelectionChange",function(e){function o(e,o){var t=e.getLine(o.line).length;return t&&o.ch!=t?o:Pos(o.line,o.ch-1)}e.on("beforeSelectionChange",function(e,t){t.update([{anchor:o(e,t.ranges[0].anchor),head:o(e,t.ranges[0].head)}])}),addDoc(e,10,10),e.execCommand("goLineEnd"),eqPos(e.getCursor(),Pos(0,9)),e.execCommand("selectAll"),eqPos(e.getCursor("start"),Pos(0,0)),eqPos(e.getCursor("end"),Pos(9,9))}),testCM("change_removedText",function(e){e.setValue("abc\ndef");var o=[];e.on("change",function(e,t){o.push(t.removed)}),e.operation(function(){e.replaceRange("xyz",Pos(0,0),Pos(1,1)),e.replaceRange("123",Pos(0,0))}),eq(o.length,2),eq(o[0].join("\n"),"abc\nd"),eq(o[1].join("\n"),"");var o=[];e.undo(),eq(o.length,2),eq(o[0].join("\n"),"123"),eq(o[1].join("\n"),"xyz");var o=[];e.redo(),eq(o.length,2),eq(o[0].join("\n"),"abc\nd"),eq(o[1].join("\n"),"")}),testCM("lineStyleFromMode",function(e){CodeMirror.defineMode("test_mode",function(){return{token:function(e){return e.match(/^\[[^\]]*\]/)?"  line-brackets  ":e.match(/^\([^\)]*\)/)?"  line-background-parens  ":e.match(/^<[^>]*>/)?"  span  line-line  line-background-bg  ":void e.match(/^\s+|^\S+/)}}}),e.setOption("mode","test_mode");var o=byClassName(e.getWrapperElement(),"brackets");eq(o.length,1,"brackets count"),eq(o[0].nodeName,"PRE"),is(!/brackets.*brackets/.test(o[0].className));var t=byClassName(e.getWrapperElement(),"parens");eq(t.length,1,"parens count"),eq(t[0].nodeName,"DIV"),is(!/parens.*parens/.test(t[0].className)),eq(t[0].parentElement.nodeName,"DIV"),eq(byClassName(e.getWrapperElement(),"bg").length,1),eq(byClassName(e.getWrapperElement(),"line").length,1);var n=byClassName(e.getWrapperElement(),"cm-span");eq(n.length,2),is(/^\s*cm-span\s*$/.test(n[0].className))},{value:"line1: [br] [br]\nline2: (par) (par)\nline3: <tag> <tag>"}),testCM("lineStyleFromBlankLine",function(e){CodeMirror.defineMode("lineStyleFromBlankLine_mode",function(){return{token:function(e){return e.skipToEnd(),"comment"},blankLine:function(){return"line-blank"}}}),e.setOption("mode","lineStyleFromBlankLine_mode");var o=byClassName(e.getWrapperElement(),"blank");eq(o.length,1),eq(o[0].nodeName,"PRE"),e.replaceRange("x",Pos(1,0)),o=byClassName(e.getWrapperElement(),"blank"),eq(o.length,0)},{value:"foo\n\nbar"}),CodeMirror.registerHelper("xxx","a","A"),CodeMirror.registerHelper("xxx","b","B"),CodeMirror.defineMode("yyy",function(){return{token:function(e){e.skipToEnd()},xxx:["a","b","q"]}}),CodeMirror.registerGlobalHelper("xxx","c",function(e){return e.enableC},"C"),testCM("helpers",function(e){e.setOption("mode","yyy"),eq(e.getHelpers(Pos(0,0),"xxx").join("/"),"A/B"),e.setOption("mode",{name:"yyy",modeProps:{xxx:"b",enableC:!0}}),eq(e.getHelpers(Pos(0,0),"xxx").join("/"),"B/C"),e.setOption("mode","javascript"),eq(e.getHelpers(Pos(0,0),"xxx").join("/"),"")}),testCM("selectionHistory",function(e){for(var o=0;3>o;o++)e.setExtending(!0),e.execCommand("goCharRight"),e.setExtending(!1),e.execCommand("goCharRight"),e.execCommand("goCharRight");e.execCommand("undoSelection"),eq(e.getSelection(),"c"),e.execCommand("undoSelection"),eq(e.getSelection(),""),eqPos(e.getCursor(),Pos(0,4)),e.execCommand("undoSelection"),eq(e.getSelection(),"b"),e.execCommand("redoSelection"),eq(e.getSelection(),""),eqPos(e.getCursor(),Pos(0,4)),e.execCommand("redoSelection"),eq(e.getSelection(),"c"),e.execCommand("redoSelection"),eq(e.getSelection(),""),eqPos(e.getCursor(),Pos(0,6))},{value:"a b c d"}),testCM("selectionChangeReducesRedo",function(e){e.replaceSelection("X"),e.execCommand("goCharRight"),e.undoSelection(),e.execCommand("selectAll"),e.undoSelection(),eq(e.getValue(),"Xabc"),eqPos(e.getCursor(),Pos(0,1)),e.undoSelection(),eq(e.getValue(),"abc")},{value:"abc"}),testCM("selectionHistoryNonOverlapping",function(e){e.setSelection(Pos(0,0),Pos(0,1)),e.setSelection(Pos(0,2),Pos(0,3)),e.execCommand("undoSelection"),eqPos(e.getCursor("anchor"),Pos(0,0)),eqPos(e.getCursor("head"),Pos(0,1))},{value:"1234"}),testCM("cursorMotionSplitsHistory",function(e){e.replaceSelection("a"),e.execCommand("goCharRight"),e.replaceSelection("b"),e.replaceSelection("c"),e.undo(),eq(e.getValue(),"a1234"),eqPos(e.getCursor(),Pos(0,2)),e.undo(),eq(e.getValue(),"1234"),eqPos(e.getCursor(),Pos(0,0))},{value:"1234"}),testCM("selChangeInOperationDoesNotSplit",function(e){for(var o=0;4>o;o++)e.operation(function(){e.replaceSelection("x"),e.setCursor(Pos(0,e.getCursor().ch-1))});eqPos(e.getCursor(),Pos(0,0)),eq(e.getValue(),"xxxxa"),e.undo(),eq(e.getValue(),"a")},{value:"a"}),testCM("alwaysMergeSelEventWithChangeOrigin",function(e){e.replaceSelection("U",null,"foo"),e.setSelection(Pos(0,0),Pos(0,1),{origin:"foo"}),e.undoSelection(),eq(e.getValue(),"a"),e.replaceSelection("V",null,"foo"),e.setSelection(Pos(0,0),Pos(0,1),{origin:"bar"}),e.undoSelection(),eq(e.getValue(),"Va")},{value:"a"}),testCM("getTokenAt",function(e){var o=e.getTokenAt(Pos(0,2));eq(o.type,"operator"),eq(o.string,"+");var t=e.getLineTokens(0);eq(t.length,3),forEach([["number","1"],["operator","+"],["number","2"]],function(e,o){eq(t[o].type,e[0]),eq(t[o].string,e[1])})},{value:"1+2",mode:"javascript"}),testCM("getTokenTypeAt",function(e){eq(e.getTokenTypeAt(Pos(0,0)),"number"),eq(e.getTokenTypeAt(Pos(0,6)),"string"),e.addOverlay({token:function(e){return e.match("foo")?"foo":void e.next()}}),eq(byClassName(e.getWrapperElement(),"cm-foo").length,1),eq(e.getTokenTypeAt(Pos(0,6)),"string")},{value:"1 + 'foo'",mode:"javascript"}),testCM("resizeLineWidget",function(e){addDoc(e,200,3);var o=document.createElement("pre");o.innerHTML="imwidget",o.style.background="yellow",e.addLineWidget(1,o,{noHScroll:!0}),e.setSize(40),is(o.parentNode.offsetWidth<42)}),testCM("combinedOperations",function(e){var o=document.getElementById("testground"),t=CodeMirror(o,{value:"123"});try{e.operation(function(){e.addLineClass(0,"wrap","foo"),t.addLineClass(0,"wrap","foo")}),eq(byClassName(e.getWrapperElement(),"foo").length,1),eq(byClassName(t.getWrapperElement(),"foo").length,1),e.operation(function(){e.removeLineClass(0,"wrap","foo"),t.removeLineClass(0,"wrap","foo")}),eq(byClassName(e.getWrapperElement(),"foo").length,0),eq(byClassName(t.getWrapperElement(),"foo").length,0)}finally{o.removeChild(t.getWrapperElement())}},{value:"abc"}),testCM("eventOrder",function(e){var o=[];e.on("change",function(){o.length||e.replaceSelection("."),o.push("change")}),e.on("cursorActivity",function(){e.replaceSelection("!"),o.push("activity")}),e.replaceSelection("/"),eq(o.join(","),"change,change,activity,change")}),testCM("splitSpaces_nonspecial",function(e){eq(byClassName(e.getWrapperElement(),"cm-invalidchar").length,0)},{specialChars:/[\u00a0]/,value:"spaces ->            <- between"}),test("core_rmClass",function(){var e=document.createElement("div");e.className="foo-bar baz-quux yadda",CodeMirror.rmClass(e,"quux"),eq(e.className,"foo-bar baz-quux yadda"),CodeMirror.rmClass(e,"baz-quux"),eq(e.className,"foo-bar yadda"),CodeMirror.rmClass(e,"yadda"),eq(e.className,"foo-bar"),CodeMirror.rmClass(e,"foo-bar"),eq(e.className,""),e.className=" foo ",CodeMirror.rmClass(e,"foo"),eq(e.className,"")}),test("core_addClass",function(){var e=document.createElement("div");CodeMirror.addClass(e,"a"),eq(e.className,"a"),CodeMirror.addClass(e,"a"),eq(e.className,"a"),CodeMirror.addClass(e,"b"),eq(e.className,"a b"),CodeMirror.addClass(e,"a"),CodeMirror.addClass(e,"b"),eq(e.className,"a b")}),testCM("lineSeparator",function(e){eq(e.lineCount(),3),eq(e.getLine(1),"bar\r"),eq(e.getLine(2),"baz\rquux"),e.setOption("lineSeparator","\r"),eq(e.lineCount(),5),eq(e.getLine(4),"quux"),eq(e.getValue(),"foo\rbar\r\rbaz\rquux"),eq(e.getValue("\n"),"foo\nbar\n\nbaz\nquux"),e.setOption("lineSeparator",null),e.setValue("foo\nbar\r\nbaz\rquux"),eq(e.lineCount(),4)},{value:"foo\nbar\r\nbaz\rquux",lineSeparator:"\n"});